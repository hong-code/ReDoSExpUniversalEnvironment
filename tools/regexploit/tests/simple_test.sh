#!/bin/bash

# Simple test script for Regexploit tool
# Tests the basic functionality with known ReDoS patterns

set -e

echo "Running simple tests for Regexploit tool..."

# Test 1: Known ReDoS pattern (v\w*_\w*_\w*$)
echo "Test 1: Testing with known ReDoS pattern"
TEST_REGEX="dlx3Kl9cdypfXHcqJA=="  # Base64 for "v\w*_\w*_\w*$"
OUTPUT_FILE="/tmp/regexploit_test1.json"

python3 ../run.py "$TEST_REGEX" "$OUTPUT_FILE"

if [ -f "$OUTPUT_FILE" ]; then
    echo "✓ Output file created successfully"
    
    # Check if JSON is valid
    if python3 -m json.tool "$OUTPUT_FILE" > /dev/null 2>&1; then
        echo "✓ Output is valid JSON"
        
        # Check if is_redos is true for this pattern
        IS_REDOS=$(python3 -c "import json; print(json.load(open('$OUTPUT_FILE'))['is_redos'])")
        if [ "$IS_REDOS" = "True" ]; then
            echo "✓ Correctly detected ReDoS vulnerability"
        else
            echo "⚠ Expected ReDoS detection, but got: $IS_REDOS"
        fi
    else
        echo "✗ Output is not valid JSON"
        cat "$OUTPUT_FILE"
        exit 1
    fi
else
    echo "✗ Output file not created"
    exit 1
fi

# Test 2: Non-ReDoS pattern
echo ""
echo "Test 2: Testing with non-ReDoS pattern"
TEST_REGEX="XGFiYyQ="  # Base64 for "^abc$"
OUTPUT_FILE="/tmp/regexploit_test2.json"

python3 ../run.py "$TEST_REGEX" "$OUTPUT_FILE"

if [ -f "$OUTPUT_FILE" ]; then
    echo "✓ Output file created successfully"
    
    # Check if JSON is valid
    if python3 -m json.tool "$OUTPUT_FILE" > /dev/null 2>&1; then
        echo "✓ Output is valid JSON"
        
        # Check if is_redos is false for this pattern
        IS_REDOS=$(python3 -c "import json; print(json.load(open('$OUTPUT_FILE'))['is_redos'])")
        if [ "$IS_REDOS" = "False" ]; then
            echo "✓ Correctly identified non-ReDoS pattern"
        else
            echo "⚠ Expected non-ReDoS, but got: $IS_REDOS"
        fi
    else
        echo "✗ Output is not valid JSON"
        cat "$OUTPUT_FILE"
        exit 1
    fi
else
    echo "✗ Output file not created"
    exit 1
fi

# Clean up
rm -f /tmp/regexploit_test*.json

echo ""
echo "All tests completed successfully!" 